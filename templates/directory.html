<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <!-- Animate CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.0/animate.min.css">

    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <title>Image directory viewer</title>
</head>

<nav class="navbar navbar-light bg-light sticky-top">
    <div class="container">
        <h4 class="display-5 mb-2">Current directory: {{current_directory}}</h4>
        <div>
            <label id="loaded" href="#">0 items loaded</label>
            <button class="btn menu" id="menu_toggle" title="Show menu"></button>
            <button class="btn magnifier" id="magnifier_toggle" title="Use magnifier"></button>
            <button class="btn label" id="sidebar_toggle" title="Open labeling sidebar"></button>
        </div>

        <div id="menu" width="100%">
            <div style="float: left; margin-right: 100px;">
                <button class="btn index" id="index_button" type="submit"
                    title="Toggle image indexes visibility"></button>
                <input type="number" id="image_index" placeholder="0" style="width: 65px" />
                <button class="btn load" id="load_button" type="submit" title="Load from index" disabled></button>
            </div>
            <div style="float: right;">
                <!--TODO: add select all / deselect here-->
                <input class="select" id="select-all-checkbox" type="checkbox" title="Select all images"
                    style="margin-right: 5px;" />
                <label id="selected">0 items selected</label>
                <input class="directory" type="text" id="destination_input" placeholder="Destination folder path "
                    autocomplete="off" list="path_options" oninput="this.setAttribute('size', this.value.length)" />
                <datalist class="datalist" id="path_options">
                    <template id="path_template">
                        <option id="path_option"></option>
                    </template>
                </datalist>
                <button class="btn move" id="move_button" type="submit" title="Move selected images" disabled></button>
            </div>
        </div>
    </div>
</nav>

<body>
    <main class="mt-3">
        <div id="images_area" style="padding-left: 8%; padding-right: 2%;">
            <div class="mt-3" id="scroller">
                <template id="image_template">
                    <div class="card mb-3 animated fadeIn shadow-sm"
                        style="position: relative; width: auto; float: left; max-height: 160">
                        <label style="padding: 3px;">
                            <label class="image-index" id=image-index></label>
                            <div class="img-magnifier-container">
                                <img id="image_bytes" class="lazy-image" />
                            </div>
                            <input type="checkbox" id="checkbox" name="checkbox"
                                style="position: absolute; right: 5px; top: 5px;" />
                        </label>
                    </div>
                </template>
            </div>

            <div class="d-flex justify-content-center mb-3" id="sentinel" style="clear: left;">
                No more files
                <!-- <div class="spinner-border" role="status"></div> -->
            </div>
        </div>
        <div id="sidebar" class="sidebar">
            <h4>Labeling</h4>
            <span>Labels for selected images:</span>
            <!-- <button id="load-labels-button" type="submit" title="Show labels">Show labels</button> -->
            <span id="labels"></span>
            <!-- <ul class="sidebar-list">
                <li class="sidebar-item">Item 1</a></li>
                <li class="sidebar-item">Item 2</a></li>
                <li class="sidebar-item">Item 3</a></li>
                <li class="sidebar-item">Item 4</a></li>
            </ul> -->
            <div style="margin-top: 20px;">
                <span>Edit labels for selected images:</span>
                <input class="label" type="text" id="label-input" placeholder="Label1 label2 label3..."
                    oninput="this.setAttribute('size', this.value.length)" />
            </div>
            <div>
                <button class="btn addlabel" id="add-labels-button" title="Add labels to selected images"></button>
                <button class="btn rmlabel" id="remove-labels-button"
                    title="Remove labels from selected images"></button>
            </div>
            <div style="margin-top: 20px;">
                <span>Export path</span>
                <input class="label" id="export_path" type="text" placeholder="/home/ubuntu/image-names.txt"
                    title="Export path" autocomplete="off" list="export_options"
                    oninput="this.setAttribute('size', this.value.length)" />
                <datalist class="datalist" id="export_options">
                    <template id="export_template">
                        <option id="export_option"></option>
                    </template>
                </datalist>
            </div>
            <div>
                <button class="btn export" id="export-labels-button" type="submit"
                    title="Export labels from selection (csv)"></button>
                <button class="btn names" id="export-names-button" type="submit"
                    title="Export imagenames from selection (txt)"></button>
            </div>
        </div>
    </main>

    <script src="{{ url_for('static', filename='utils.js') }}"></script>
    <script src="{{ url_for('static', filename='magnifier.js') }}"></script>
    <script>
        const menu = document.querySelector('#menu');
        const menuToggle = document.querySelector('#menu_toggle');
        menuToggle.addEventListener('click', event => { menu.classList.toggle('hide'); });
        const magnifierToggle = document.querySelector("#magnifier_toggle");
        var magnifierOn = false;
        magnifierToggle.addEventListener('click', event => { magnifierOn = !magnifierOn; });

        const imagesDiv = document.querySelector('#images_area')

        const sidebar = document.querySelector('#sidebar');
        const sidebarToggle = document.querySelector('#sidebar_toggle');
        sidebarToggle.addEventListener('click', function () {
            sidebar.classList.toggle('show');
            imagesDiv.classList.toggle("move-to-left");
        });

        // Move & load buttons check area
        let d = document, [destinationInput, moveButton, indexButton, imageIndexInput, loadButton] = [
            d.querySelector('#destination_input'),
            d.querySelector('#move_button'),
            d.querySelector('#index_button'),
            d.querySelector('#image_index'),
            d.querySelector('#load_button')]

        imageIndexInput.addEventListener('input', () => {
            loadButton.disabled = (/^ *$/.test(imageIndexInput.value));
        })

        indexButton.addEventListener('click', event => {
            imageIndexes.forEach(index => index.classList.toggle('hide'));
        });

        moveButton.addEventListener('click', event => { moveItems(); });

        destinationInput.addEventListener('input', () => {
            moveButton.disabled = (/^ *$/.test(destinationInput.value));
            showPrompt(destinationInput.value);
        });

        loadButton.addEventListener('click', event => {
            images[parseInt(imageIndexInput.value)].scrollIntoView();
        });

        const scroller = document.querySelector("#scroller");
        var checkboxes = document.getElementsByName('checkbox');
        var currentDirectory = `{{ current_directory }}`;
        var totalCounter = `{{ total }}`;

        var labelsSpan = sidebar.querySelector("#labels");
        var exportLabelsButton = document.querySelector("#export-labels-button");
        exportLabelsButton.addEventListener('click', event => { exportLabels(); });
        var exportNamesButton = document.querySelector("#export-names-button");
        exportNamesButton.addEventListener('click', event => { exportSelectedImageNames(); });
        var exportPathInput = document.querySelector("#export_path");
        exportPathInput.addEventListener('input', () => {
            exportLabelsButton.disabled = (/^ *$/.test(exportPathInput.value));
            exportNamesButton.disabled = (/^ *$/.test(exportPathInput.value));
            showExportPrompt(exportPathInput.value);
        });

        var addLabelsButton = sidebar.querySelector("#add-labels-button");
        addLabelsButton.addEventListener('click', event => {
            editLabels(`/add_labels`);
            getLabels();
        })
        var removeLabelsButton = sidebar.querySelector("#remove-labels-button");
        removeLabelsButton.addEventListener('click', event => {
            editLabels(`/remove_labels`);
            getLabels();
        });
        var labelInput = sidebar.querySelector("#label-input");
        labelInput.addEventListener('input', () => {
            addLabelsButton.disabled = (/^ *$/.test(labelInput.value));
            removeLabelsButton.disabled = (/^ *$/.test(labelInput.value));
        });
        var downloadLink = document.createElement('a');
        downloadLink.download = "labels.csv";

        var imageTemplate = document.querySelector('#image_template');
        var loaded = document.querySelector("#loaded");
        var selected = document.querySelector("#selected");
        var selectCheckbox = document.querySelector("#select-all-checkbox");
        selectCheckbox.addEventListener('change', () => { toggleSelectAll(); });
        const sentinel = document.querySelector('#sentinel');

        var loadCounter = 0;
        var checkboxCounter = 0;
        var images = [];
        var imageIndexes = [];

        const interactSettings = {
            root: document.querySelector('#mt-3'),
            rootMargin: '0px 0px 200px 0px'
        };

        const intersectionObserver = new IntersectionObserver(onIntersection, interactSettings);

        listenClickOnEnter(imageIndexInput, loadButton);
        listenClickOnEnter(destinationInput, moveButton);

        loadItems();

        // Methods

        function removeElement(element) {
            scroller.removeChild(element)
        }

        function moveItems() {
            let destination = destinationInput.value;
            if (destination === currentDirectory) {
                alert(`You are already in ${currentDirectory}`)
                return;
            }

            let imageIndexes = [];
            let checkboxesToRemove = [];
            for (let i = 0; i < checkboxes.length; i++) {
                if (checkboxes[i].checked) {
                    const checkbox = checkboxes[i]
                    imageIndexes.push(checkbox.value);
                    checkboxesToRemove.push(checkbox);
                }
            }

            if (!imageIndexes.length) {
                alert("Images are not chosen");
                return;
            }

            for (let i = 0; i < checkboxesToRemove.length; i++) {
                removeElement(checkboxesToRemove[i].parentNode.parentNode);
                totalCounter -= 1;
                loadCounter -= 1;
            }

            loaded.innerText = `${loadCounter} from ${totalCounter} items loaded`;

            json = {
                "destination": destination,
                "indexes": imageIndexes
            };

            checkboxCounter = 0;
            selected.innerText = `${checkboxCounter} items selected`;

            fetch(`/move`, {
                method: "POST",
                credentials: "include",
                body: JSON.stringify(json),
                cache: "no-cache",
                headers: new Headers({
                    "content-type": "application/json"
                })
            }).then((response) => response.json()).then((data) => { if (data) { alert(data); } });
        }

        // Path prompt

        async function getImages(loadImages) {
            let images_len = loadImages.length
            let pathList = [];
            loadImages.forEach(image => {
                pathList.push(image.title);
            });

            json = {
                "pathList": pathList
            }

            return fetch(`/get_images`, {
                method: "POST",
                credentials: "include",
                body: JSON.stringify(json),
                cache: "no-cache",
                headers: new Headers({
                    "content-type": "application/json"
                })
            }).then(async (response) => {
                const res = await response.json();
                for (let i = 0; i < res.length; i++) {
                    const image = loadImages[i];
                    image.setAttribute('src', res[i][0]);
                    const imageSize = res[i][1];
                    image.title += `, size: (${imageSize[0]}x${imageSize[1]})`
                    image.onload = () => {
                        image.classList.toggle('loaded', true);
                    }
                    loadCounter += 1;
                }
                loaded.innerText = `${loadCounter} from ${totalCounter} items loaded`;
                // if (loadCounter == totalCounter) { sentinel.innerHTML = "No more files"; }
            });
        }

        async function getFullImage(image_path) {
            json = {
                "path": image_path
            }

            return fetch(`/get_fullsize_image`, {
                method: "POST",
                credentials: "include",
                body: JSON.stringify(json),
                cache: "no-cache",
                headers: new Headers({
                    "content-type": "application/json"
                })
            }).then(async (response) => {
                const jsonData = await response.json();
                return jsonData.toString();
            });
        }

        // Loading part

        function loadItems() {
            fetch(`/load`).then((response) => {
                response.json().then((data) => {
                    let files_quantity = data.length;

                    // if (!files_quantity) {
                    //     sentinel.innerHTML = "No more files";
                    //     return;
                    // }

                    for (let i = 0; i < files_quantity; i++) {
                        let templateClone = imageTemplate.content.cloneNode(true);

                        templateClone.querySelector("#image_bytes").title = `${data[i][0]}`;
                        const checkbox = templateClone.querySelector("#checkbox");
                        checkbox.value = i;

                        checkbox.addEventListener('change', function () {
                            if (this.checked) {
                                checkboxCounter += 1;
                            } else {
                                checkboxCounter -= 1;
                            }
                            selected.innerText = `${checkboxCounter} items selected`;
                            getLabels();
                        });

                        const indexLabel = templateClone.querySelector("#image-index");
                        indexLabel.innerHTML = i;

                        templateClone.querySelector("#image_bytes").addEventListener('mouseenter', async (event) => {
                            let imageNode = event.srcElement;
                            if (imageNode.tag) {
                                if (magnifierOn) { magnify(imageNode); }
                                return;
                            }
                            imageNode.classList.toggle('loaded', false);
                            getFullImage(imageNode.title.split(", size: ")[0]).then(res => {
                                imageNode.setAttribute('src', res);
                                imageNode.classList.toggle('loaded', true);
                                imageNode.tag = 'set'
                                if (magnifierOn) { magnify(imageNode); }
                            });
                        });
                        scroller.appendChild(templateClone);
                    }

                    images = [...document.querySelectorAll('.lazy-image')];
                    images.forEach(image => intersectionObserver.observe(image));
                    imageIndexes = [...document.querySelectorAll(".image-index")];
                })
            })
        }

        function onIntersection(imageEntites) {
            let loadImages = [];
            imageEntites.forEach(intersectionEntity => {
                if (intersectionEntity.isIntersecting) {
                    intersectionObserver.unobserve(intersectionEntity.target);
                    loadImages.push(intersectionEntity.target)
                }
            });
            getImages(loadImages);
        }

        // Labels part

        function editLabels(endpoint) {
            let imageIndexes = [];
            for (let i = 0; i < checkboxes.length; i++) {
                if (checkboxes[i].checked) {
                    const checkbox = checkboxes[i]
                    imageIndexes.push(checkbox.value);
                }
            }

            if (!imageIndexes.length) {
                alert("Images are not chosen");
                return;
            }

            let json = {
                "indexes": imageIndexes,
                'labels': labelInput.value
            }

            return fetch(endpoint, {
                method: "POST",
                credentials: "include",
                body: JSON.stringify(json),
                cache: "no-cache",
                headers: new Headers({
                    "content-type": "application/json"
                })
            }).then((response) => response.json()).then((data) => { if (data) { alert(data); } });
        }

        async function getLabels() {
            let imageIndexes = [];
            for (let i = 0; i < checkboxes.length; i++) {
                if (checkboxes[i].checked) {
                    const checkbox = checkboxes[i]
                    imageIndexes.push(checkbox.value);
                }
            }

            if (!imageIndexes.length) {
                labelsSpan.innerHTML = '';
                return;
            }

            let json = {
                "indexes": imageIndexes
            }

            return fetch(`/get_labels`, {
                method: "POST",
                credentials: "include",
                body: JSON.stringify(json),
                cache: "no-cache",
                headers: new Headers({
                    "content-type": "application/json"
                })
            }).then(async (response) => {
                const res = await response.json();
                console.log(res)
                labelsSpan.innerHTML = res;
            });
        }

        function exportLabels() {
            let imageIndexes = [];
            for (let i = 0; i < checkboxes.length; i++) {
                if (checkboxes[i].checked) {
                    const checkbox = checkboxes[i]
                    imageIndexes.push(checkbox.value);
                }
            }

            if (!imageIndexes.length) {
                alert("Images are not chosen");
                return;
            }

            let json = {
                "indexes": imageIndexes,
                "path": exportPathInput.value,
            }

            return fetch(`/export_labels`, {
                method: "POST",
                credentials: "include",
                body: JSON.stringify(json),
                cache: "no-cache",
                headers: new Headers({
                    "content-type": "application/json"
                })
            }).then((response) => response.json()).then((data) => { if (data) { alert(data); } });
        }

        function exportSelectedImageNames() {
            let imageIndexes = [];
            for (let i = 0; i < checkboxes.length; i++) {
                if (checkboxes[i].checked) {
                    const checkbox = checkboxes[i]
                    imageIndexes.push(checkbox.value);
                }
            }

            if (!imageIndexes.length) {
                alert("Images are not chosen");
                return;
            }

            let json = {
                "indexes": imageIndexes,
                "path": exportPathInput.value,
            }

            return fetch(`/export_imagenames`, {
                method: "POST",
                credentials: "include",
                body: JSON.stringify(json),
                cache: "no-cache",
                headers: new Headers({
                    "content-type": "application/json"
                })
            }).then((response) => response.json()).then((data) => { if (data) { alert(data); } });
        }

        //TODO: change to selected logic when add select all button
        //TODO: use it
        function exportLabelsLocally() {
            fetch(`/export_labels_local`).then((response) => {
                response.json().then((data) => {
                    let csvContent = "data:text/csv;charset=utf-8,"
                        + data.map(e => e.join(",")).join("\n");

                    downloadLink.href = csvContent;
                    downloadLink.click();
                })
            });
        }

        // Other methods

        function toggleSelectAll() {
            for (let i = 0; i < checkboxes.length; i++) {
                checkboxes[i].checked = !checkboxes[i].checked;
            }
        }

    </script>

</body>

</html>